<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Furqan Islamic Institute Incorporated</title>
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0//css/bootstrap.min.css}">
    <script th:src="@{https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js}"></script>
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css}">
    <script th:src="@{https://kit.fontawesome.com/a076d05399.js}"></script>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<script th:src="@{/js/script.js}" defer></script>
<script th:src="@{/js/sidebar.js}" defer></script>

<body>
    <!-- Sidebar -->
    <div th:replace="~{fragments/fragment :: sidebar}"></div>

    <!-- Topbar with Hamburger & User Icon -->
    <div class="dashboard-container" id="content">
        <div class="sticky-header">
            <!-- Topbar -->
            <div th:replace="~{fragments/fragment :: topbar}"></div>

            <div class="text-link">
                <h4>Book Distribution</h4>
                <a href="/home">Main</a>
                <p>/</p>
                <a href="/transaction/academic-resources" title="You're currently in this page.">Transaction - Book Distribution</a>
            </div>

            <div class="search-div">
                <!-- Searchbox and sort btn -->
                <div class="search">
                    <div class="search-container">
                        <input type="text" placeholder="Search..." class="search-input" />
                        <button class="search-btn">Search</button>
                    </div>
                    <div class="sort-container">
                        <select name="sort" id="sort-select" class="sort-select">
                            <option value="" disabled selected>Sort</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <table id="table-ko" class="payment-report-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Grade Level</th>
                    <th>Item</th>
                    <th>Status</th>
                    <th>Date Received</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6">No records found</td></tr>
            </tbody>
        </table> <br> <br>
        <!-- Modal for confirmation -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <p id="modalText"></p>
                <div class="modal-buttons">
                    <button id="confirmAction" class="btn-confirm">Confirm</button>
                    <button class="btn-close-confirm" data-close-modal="confirmationModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            setUpTables();
        });

async function setUpTables() {
    try {
        const response = await fetch("/distributable/student-distribution/all");

        if (!response.ok) {
            console.error("Failed to fetch data:", response.status);
            return;
        }

        const data = await response.json();
        console.log("Fetched data:", data);

        const tableBody = document.querySelector("#table-ko tbody");
        if (!tableBody) {
            console.error("Table body not found");
            return;
        }

        // Clear existing rows
        tableBody.innerHTML = '';

        if (!data.content || data.content.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6">No records found</td></tr>`;
            return;
        }

        // Create document fragment for better performance
        const fragment = document.createDocumentFragment();

        data.content.forEach(studDis => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${studDis.student?.fullName || 'N/A'}</td>
                <td>${studDis.gradeLevel?.levelName || 'N/A'}</td>
                <td>${studDis.itemName || 'N/A'}</td>
                <td>${studDis.isReceived ? "Claimed" : "Not Claimed"}</td>
                <td>${studDis.dateReceived || "N/A"}</td>
                <td>
                    <div class="dropdown">
                        <div class="action-container action">
                            <button class="add-something-btn"
                                data-open-modal="addPaymentModal"
                                data-student-id="${studDis.student?.id || ''}"
                                data-item-id="${studDis.itemId || ''}">
                                Distribute
                            </button>
                        </div>
                    </div>
                </td>`;
            fragment.appendChild(row);
        });

        tableBody.appendChild(fragment);

    } catch (error) {
        console.error("Error setting up tables:", error);
        // Optional: Show user-friendly error message in UI
        const tableBody = document.querySelector("#table-ko tbody");
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="6">Error loading data. Please try again.</td></tr>`;
        }
    }
}
    </script>
</body>

</html>